var inner_scheduler = require('node-schedule');
var relay = require('pecan-relay');

function getScheduledTime(baseDate, scheduled) {
  var time = new Date(baseDate.getTime());
  time.setHours(scheduled.hour);
  time.setMinutes(scheduled.minute);

  return time;
}

var scheduler = {
  init: function (config) {
    config.forEach(function (sch) {
      // on     
      inner_scheduler.scheduleJob({
        hour: sch.on.hour,
        minute: sch.on.minute
      }, function () {
        relay.set(sch.id, true);
      });

      // off
      inner_scheduler.scheduleJob({
        hour: sch.off.hour,
        minute: sch.off.minute
      }, function () {
        relay.set(sch.id, false);
      });

      var now = new Date();
      var onTime = getScheduledTime(now, sch.on);
      var offTime = getScheduledTime(now, sch.off);

      relay.set(sch.id, 
        (onTime < now) && (now < offTime));
    });
  }
};

module.exports = scheduler;